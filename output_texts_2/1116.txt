Sophos Home protects every Mac and PC in your home 
Itâ€™s three weeks since the word HAFNIUM hit the news.
The word Hafnium refers to a cybergang who are said to focus on stealing data from pretty much anyone and everyone they can infiltrate, across an eclectic range of industry sectors, and this time they hit a sort-of cybercrime jackpot.
The Hafnium crew, it turned out, not only knew about four zero-day vulnerabilities in Microsoft Exchange, but also knew how to exploit these bugs reliably in order to walk into unprotected networks almost at will.
The Exchange bugs didnâ€™t include a remote code exeution (RCE) hole to give the crooks the direct and immediate access to a compromised server, but the bugs did allow the crooks to rig up RCE using a trick known as a webshell.
Greatly simplified, the attack goes like this:
Unfortunately, as we explained when this news first broke, the name Hafnium caused fourfold confusion:
Itâ€™s the last of these issues that concerns us here, because the Sophos Managed Threat Response team recently investigated a number of cases in which networks that hadnâ€™t been patched against the abovementioned Exchange bugs had been infiltrated and attacked by a strain of ransomware going by the dramatic name of BlackKingdom.
In case youâ€™re wondering, the crooks variously refer to their own ransomware using two words, weirdly written Black KingDom, as well using one word, as weâ€™ve written it here. (Weâ€™ll stick to BlackKingdom in order to make it clear that we are talking about a specific threat, in the same way that we might write WannaCry or TeslaCrypt.)
The bugs exploited in this case are now widely referred to as ProxyLogon, which is the popular name used to refer to attacks that start off by using the Exchange bug CVE-2021-26855, typically followed by using CVE-2021-27065 and perhaps CVE-2021-26857 and CVE-2021-26858. The name ProxyLogin is a better word to use than Hafnium if youâ€™re specifically talking about an intrusion initiated by those bugs, because the name isnâ€™t tied to any criminal gang, and doesnâ€™t imply any specific reason for the attack.
If youâ€™re after the low-level details of BlackKingdom, youâ€™ll be glad to know that SophosLabs has published a technical analysis of the malware program that does the dirty work.
Read the Labs report if you want to find out exactly how the malware works, and to get indicators of compromise you can look for on your network and in your own logs.
Although BlackKingdom is not technically sophisticated, thatâ€™s cold comfort if itâ€™s just scrambled all your files.
As SophosLabs put it:
[O]ur early analysis reveals that it is somewhat rudimentary and amateurish in its composition, but it can still cause a great deal of damage.
Black Kingdom ransomware begins appearing on Exchange servers


Like many families of ransomware, this one:
The blackmail demand starts like this:
The amount demanded is $10,000 in Bitcoin for each computer attacked:
Whether or not the criminals behind this attack really are routinely stealing their victimsâ€™ files before scrambling them, we arenâ€™t sure.
However, as you will see from the SophosLabs analysis, the ransomware program that produces this message was installed and executed using the ProxyLogon exploits, which allow remote crooks to implant and run almost any program they want.
So even if they didnâ€™t steal all your data first, they almost certainly could haveâ€¦
â€¦and so could any other crooks who came across your unpatched servers before, during or after the BlackKingdom attack.
By the way, there are a few peculiarities about the BlackKingdom malware that give you a small (though it may admittedly only be a very small) chance of recovering your data, even if you donâ€™t have a backup, without paying the criminals for the decryption key.
So if you do end up as a victim of this attack, talk to someone you know and trust for advice before you rush into any ill-considered response.
If you have suffered any sort of cybercrime attack, including but not limited to ransomware, and you donâ€™t have an IT partner of your own to turn to, the Sophos Managed Threat Response or Sophos Rapid Response team would be happy to hear from you.
LEARN MORE: HAFNIUM EXPLAINED IN PLAIN ENGLISH

Original video here: https://www.youtube.com/watch?v=xVasO4k-mMQ
Click the cog icon to speed up playback or show live subtitles.

Follow @NakedSecurity on Twitter for the latest computer security news.
Follow @NakedSecurity on Instagram for exclusive pics, gifs, vids and LOLs!
â€œunlocking up your database filesâ€ should be â€œlocking up your database filesâ€.
Fixed, thanks! (Actually, it was supposed to be simply â€œunlockingâ€ :-)
Peruse your logs. Crooks donâ€™t always succeed at their first attempt, so keep your eye open for signs that an attack may be under way.
All very well to say if you are a trained IT Security specialist â€“ but then if you are, you will already be doing this?
But if you are not? Either because you are a small firm â€œrelyingâ€ on an IT partner whose â€œofferingâ€ in terms of cybersecurity you donâ€™t really understand or because you are an individual possibly with hosted webspace/email or even with a single PC? Reading log files would be like reading a thesaurus not just in a language we donâ€™t understand but in a script so foreign that we are not even sure whether it reads left to right!
So for those of us say running a PC or two (Windows/Mac/Linux) connected via a modem-router (with presumably its own logfiles) to third party hosted email-servers and webspace, what does â€œPeruse your logsâ€ actually mean in practice? Presumably part of your daily IT hygiene activities, but what should we be looking for, where and how? (â€œfindâ€/â€grepâ€?)
Good question, and strangely both easy and hard to answer :-)
That advice was largely aimed at the sort of company that *could* (and has a fairly good ides of how to) â€œperuse its logsâ€. Sadly, your rhetorical question does have an answer, namely that many companies, of all sizes, struggle to make the time to work through their logs, because, well, lifeâ€™s like that. My point here, therefore, is simply to say, â€œBecause your networkâ€™s worth it.â€
For home users, however, â€œhow to do itâ€ really is a tough question to answer, especially where your router is concerned, because every manufacturer/vendor/ISP/firmware flavout seems to do it differently.
As a starting point, I recommend logging into your routerâ€™s web interface (hopefully itâ€™s on;ly accesible from inside!) and learning your way around, just so you know what information you can get out of it when needed. 
Whenever I get a new router I spend an hour or so trying all the options on every menu on every screen, and I jot down the location of useful-looking settings or info pages so I can find them easily next time, e.g. how to review which inbound connections are allowed and edit them, how to generate a list of all devices that are (or have been) on the network since last time I looked, and what sort of text-based logfiles I can download (and what settings exist to discard info I think I am simply never going to use, to keep the logs more manageable). Sometimes, uaeful information gets hidden away N levels deep in tabs+menus+options, and unless you go spelunking you may never find it.
Then I download sample logfiles and pore over them for a while, and (as you suggest) practise searching them for useful-looking strings with simle tools like find/grep. If I can, I will try probing my own router from outside first in order to see what the log entries look like for known-good and known-bad connection attempts. 
If nothing else, make sure you review your connection list from time to time â€“ not so much to catch out any nosy neighbours, but to make sure that old devices you thought you had disconnected, like the â€œoldâ€ smart TV that is no longer getting Android security updates, really *did* get removed from your network.
Also, remember to go in and download/clean old log entries regularly, given that your router probably doesnâ€™t have much storage.
PS. If you have port 22 (SSH) open, be prepared for a *lot* (hundreds? thousands? millions?) of failed login attempts. Automated scanners typically find you within a few minutes of your modem connecting. Moving SSH to another randimly chosen port will not improve security, but you might want to do it anyway because it will almost certainly reduce the SSH â€œlog spamâ€ you get.
Thanks for your detailed reply â€“ which prompted me to revisit my router logs (which I do not examine as much as the server logs on my (external) webhost â€“ which has previously been attacked).
My router (Linksys â€“ piggybacked on an old netgear modem/router) does not have extensive logs (I expect that it also dumps logs after a given period â€“ the logs are pretty short, but I cannot find in the documentation any reference to them being â€œrolling x hoursâ€ logs)
No unexpected â€œactiveâ€ devices under the â€œStatusâ€ page â€“ although the DHCP client list does list more devices (but again no surprises â€“ includes inactive devices)
â€œIncoming Logâ€ is empty â€“ presumably it means â€œnothing coming in other than in response to web requests and email pollingâ€ from me â€“ so good â€“ I think!
â€œOutgoing Logâ€ is sparse; a short list without timestamps of (for the last 24 hours):
Lan IP Address â€“ constant 192.168. etc â€“ OK
Destination URL â€“ remarkably few unique hosts when I manually(!) do a WhoIs? check on each one: My web/email host, my ISP, Google LLC, Amazon technologies, Amazon, Automattic (WordPress), Fastly, Akamai Technologies, Canonical Group, (I have visited far more websites during this time â€“ including Sophos â€“ but presumably they are hidden behind my ISP)
Service* â€“ imap, pop3s, www, â€œdomainâ€ (to my ISP), https, pop3, ntp
â€œSecurity Logâ€ â€“ empty (LAN IP address | MAC address | Timestamp | Authentication result)
â€œDHCP Logâ€ â€“ empty (LAN IP address | MAC address | Timestamp | Message Type)
* Service
No SSH â€“ which is good although I see no setting on the router to turn it off / prohibit it
So the pop3 should not be there, I have tracked down the relevant email account and changed it to Port 995.
Not sure why Amazon technologies should attempt to use ntp â€“ presumably an Amazon AWS client (but who and what are they doing? Canonical doing an Ubuntu update?).
Also, strangely no â€œhttpâ€ even though a lot of abbreviated links in (trusted) emails (typically news briefings from well known publications e.g. Scientific American ) are http â€“ triggering a â€œno httpsâ€ warning in Firefox; I have to continue with http and they then resolve to an https link.
So the review raises a few questions that I do not know how to resolve and leaves me feeling â€œother than that everything looks OKâ€ â€“ but with an uncomfortable feeling that perhaps the logs are not telling me enough? I suspect that this is typical of many home / home office users?
Time to flash my router with third party router software that might tell me more?
Linksys was the brand that inspired OpenWRT in the first placeâ€¦ just make sure your model is properly supported. If you have a separate modem then you are in a good position.
If youâ€™re feeling adventurous (by which I mean if you have a spare computer, e.g. laptop) you could try the Sophos Firewall Home Edition. You get everything for free (including malware scanning, email filtering, web filtering, IPS, VPN and so on):
https://www.sophos.com/en-us/products/free-tools/sophos-xg-firewall-home-edition.aspx
Thanks again â€“ I have been toying with Sophos Firewall Home Edition. You are right to say â€œif you are feeling adventurousâ€:
â€“ I am happy about installing a specialist OS (it is how I set up my laptops with Linux), so that is not too adventurous
â€“ â€œWhat you need: Intel compatible computer with dual network interfaces.â€ How many laptops have dual network interfaces (or are they virtual?)? If so I struggle to visualise the physical set-up; presumably not an ethernet chain [modem/router ->- firewall laptop ->- main router]?
â€“ I have an old but 64bit Intel laptop (Intel Celeron Dual-Core T3100 2 x 1.9 GHz) with a dead graphics chip (but the HDMI interface works) with a single Ethernet port which might be OK, but what happens to the throughput if you try and use an old USB port on an already oldish laptop as a network port?
(The Sophos support forums require me to register, but when I attempt to do so I find that all the â€œregistration fieldsâ€ are actually images, so I seem excluded?)
I have previously wondered about getting a mini-PC with a couple of ethernet adaptors (were about Â£350); if Sophos recommended such hardware I would go for it with more confidence.
On the other hand my Linksys router is compatible with OpenWRT! (Presumably your reference to being in a good position with a modem router is referring to having a backup provision should I brick my router?)
You could try just setting up your Sophos Home appliance in a VM with two virtual interfaces, one set up to NAT its way onto the internet and the other set up to map onto the host adapter so that the appliance is bridged (is that the right word?) onto your LAN.
If you run the VM â€œheadlessâ€ then you wonâ€™t need a screen on the laptop. (And laptops with even a bit of battery life left have a built-in UPS!)
Or you could try plugging in a $5 USB-to-Ethernet dongle that you know Linux will readily recognise. (Our Firewall appliance is Linux based.) I havenâ€™t tried this myself but I am assuming it will workâ€¦
There is also an official way (more precisely, there was the last time I tried it :-) to get a console login to your appliance so in theory I suspect you could set up two interfaces on one physical port, using different IP subnets, but that approach would be more of a science project than usual.
Given that you have a spare computer you might as well try it â€“ the appliance licence costs $0 so you can have your money back if it doesnâ€™t work, hahahahaha.
Great article and another eye-opener, thanks Paul.  Due to its severity, itâ€™s good to see that Sophosâ€™ knowledge of this particular threat and mitigation is continuously driven.
â€œWhat to do?
Patch early, patch often. If youâ€™re genuinely think uou are at riskâ€¦â€ doesnâ€™t read quite right ğŸ™‚
However, the message is very clear.  Patching this threat (and in general) should be a priority for us all.
Fixed, thanks!
Itâ€™s the wild west out here. Weâ€™re in Dodge City and we have no sheriff.
Comment * 
Name 
Email 
Website 
 



Î”